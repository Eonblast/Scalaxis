#   Copyright 2007-2008 Konrad-Zuse-Zentrum fÃ¼r Informationstechnik Berlin
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

ERLC = @ERLC@
ERL = @ERL@
DIALYZER = @ERLANG_ROOT_DIR@/bin/dialyzer
SVN = svn
CD = cd
MAKE = make
VERSION=0.0.1



YAWS_PATH= /usr/local/lib/yaws

APP_NAME = chordsharp

VSN = $Id$

prefix = @prefix@
exec_prefix = @exec_prefix@

# /bin
BINDIR = $(DESTDIR)@bindir@
# /etc/scalaris/
ETCDIR = $(DESTDIR)@sysconfdir@/scalaris
# /lib/scalaris/
SCALARISDIR = $(DESTDIR)@libdir@/scalaris
# /lib/scalaris/ebin
BEAMDIR = $(DESTDIR)@libdir@/scalaris/ebin
# /lib/scalaris/docroot
DOCROOTDIR=$(SCALARISDIR)/docroot
# /lib/scalaris/docroot_node
NODEDOCROOTDIR=$(SCALARISDIR)/docroot_node
# /share/doc/scalaris
DOCDIR=$(DESTDIR)@docdir@/
# /share/java
JAVADIR=$(DESTDIR)@datarootdir@/java
# /var/log/scalaris
LOGDIR=$(DESTDIR)@localstatedir@/log/scalaris

all: compile
#all: compile dialyzer java test docs

#cp priv/xbin/*beam bin/
compile:
	@$(ERL) -pa contrib/yaws -pa ebin -noinput +B -eval 'case make:all() of up_to_date -> halt(0); error -> halt(1) end.'


test: compile
	@ERLANG_LIB_DIR_common_test@/priv/bin/run_test -pa `pwd`/ebin `pwd`/contrib/yaws/ebin `pwd`/contrib/log4erl/ebin -dir . -cover test/scalaris.coverspec

test-vts: compile
	@ERLANG_LIB_DIR_common_test@/priv/bin/run_test -pa `pwd`/ebin `pwd`/contrib/yaws/ebin `pwd`/contrib/log4erl/ebin -dir . -cover test/scalaris.coverspec -vts -browser konqueror

java:
	$(CD) java-api && ant jar

clean:
	-rm -rf bin/*.beam
	-rm -rf ebin/*.beam
	-rm -rf src/*.beam
	-rm -rf src/comm_layer/*.beam
	-rm -rf src/pubsub/*.beam
	-rm -rf src/transstore/*.beam
	-rm -rf contrib/yaws/ebin/*.beam
	-rm -rf contrib/log4erl/ebin/*.beam
	-rm -rf test/*.beam
	-rm -rf doc/*.html
	-rm -rf doc/*.css
	-rm -rf doc/edoc-info
	-rm -rf docroot/graphs/*.png

docs:
	$(ERL) -noshell -run edoc_run application "'$(APP_NAME)'" \
	'"."' '[{def,{vsn,"$(VSN)"}}]'
	$(CD) java-api && ant doc

svn:
	$(SVN) propset svn:keywords Id src/*.erl src/comm_layer/*.erl  src/pubsub/*.erl  src/transstore/*.erl tests/*.erl bin/*.app bin/*.cfg

dialyzer:
	$(DIALYZER) -Wunderspecs -Werror_handling -c ebin contrib/log4erl/ebin/ contrib/yaws/ebin/

rrd-init:
	@echo This target is deprecated

install: all java
	@echo $(DESTDIR)
	@echo @prefix@
	mkdir -p $(BEAMDIR)
	install -m 644 bin/*.app $(BEAMDIR)
	install -m 644 ebin/*.beam $(BEAMDIR)
	mkdir -p $(ETCDIR)
	install bin/scalaris.cfg bin/scalaris.local.cfg.example $(ETCDIR)
	mkdir -p $(DOCROOTDIR)
	install -m 644 docroot/*.yaws $(DOCROOTDIR)
	install -m 644 docroot/*.css $(DOCROOTDIR)
	install -m 644 docroot/*.js $(DOCROOTDIR)
	install -m 644 docroot/*.gif $(DOCROOTDIR)
	mkdir -p $(DOCROOTDIR)/icons
	install -m 644 docroot/icons/*.gif $(DOCROOTDIR)/icons
	mkdir -p $(DOCROOTDIR)/images/default
	mkdir -p $(DOCROOTDIR)/images/default/dd
	mkdir -p $(DOCROOTDIR)/images/default/panel
	mkdir -p $(DOCROOTDIR)/images/default/tree
	mkdir -p $(DOCROOTDIR)/images/default/grid
	install -m 644 docroot/images/default/dd/*.gif $(DOCROOTDIR)/images/default/dd
	install -m 644 docroot/images/default/panel/*.gif $(DOCROOTDIR)/images/default/panel
	install -m 644 docroot/images/default/panel/*.png $(DOCROOTDIR)/images/default/panel
	install -m 644 docroot/images/default/tree/*.gif $(DOCROOTDIR)/images/default/tree
	install -m 644 docroot/images/default/grid/*.gif $(DOCROOTDIR)/images/default/grid
	install -m 644 docroot/images/default/grid/*.png $(DOCROOTDIR)/images/default/grid
	mkdir $(NODEDOCROOTDIR)
	install docroot_node/*.yaws $(NODEDOCROOTDIR)
	mkdir -p $(SCALARISDIR)/contrib/yaws/ebin
	install contrib/yaws/ebin/*.beam $(SCALARISDIR)/contrib/yaws/ebin
	mkdir -p $(SCALARISDIR)/contrib/yaws/include
	install contrib/yaws/include/yaws_api.hrl $(SCALARISDIR)/contrib/yaws/include
	mkdir -p $(SCALARISDIR)/contrib/log4erl/ebin
	install contrib/log4erl/ebin/*.beam $(SCALARISDIR)/contrib/log4erl/ebin
	install contrib/log4erl/ebin/*.app $(SCALARISDIR)/contrib/log4erl/ebin
	mkdir -p $(LOGDIR)
	mkdir -p $(DOCDIR)/erlang
	install -m 644 doc/*.html $(DOCDIR)/erlang
	install -m 644 doc/*.png $(DOCDIR)/erlang
	mkdir -p $(DOCDIR)/erlang/comm_layer
	install -m 644 doc/comm_layer/*.html $(DOCDIR)/erlang/comm_layer
	mkdir -p $(DOCDIR)/erlang/pubsub
	install -m 644 doc/pubsub/*.html $(DOCDIR)/erlang/pubsub
	mkdir -p $(DOCDIR)/erlang/transstore
	install -m 644 doc/transstore/*.html $(DOCDIR)/erlang/transstore
	mkdir -p $(DOCDIR)/java-api
	mkdir -p $(DOCDIR)/java-api/resources
	mkdir -p $(DOCDIR)/java-api/de/zib/chordsharp/class-use
	mkdir -p $(DOCDIR)/java-api/de/zib/chordsharp/examples/class-use
	install -m 644 java-api/doc/*.html $(DOCDIR)/java-api
	install -m 644 java-api/doc/resources/*.gif $(DOCDIR)/java-api/resources
	install -m 644 java-api/doc/de/zib/chordsharp/*.html $(DOCDIR)/java-api/de/zib/chordsharp
	install -m 644 java-api/doc/de/zib/chordsharp/class-use/*.html $(DOCDIR)/java-api/de/zib/chordsharp/class-use
	install -m 644 java-api/doc/de/zib/chordsharp/examples/*.html $(DOCDIR)/java-api/de/zib/chordsharp/examples
	install -m 644 java-api/doc/de/zib/chordsharp/class-use/*.html $(DOCDIR)/java-api/de/zib/chordsharp/class-use
	mkdir -p $(JAVADIR)/scalaris
	install java-api/scalaris.jar $(JAVADIR)/scalaris/
	mkdir -p $(JAVADIR)/scalaris/lib
	install java-api/lib/OtpErlang-1.4.2.jar $(JAVADIR)/scalaris/lib/
	install java-api/scalaris-java.conf.sample $(ETCDIR)/scalaris-java.conf
	install java-api/scalaris-java.conf.sample $(ETCDIR)/
	install java-api/scalaris.properties $(ETCDIR)/
	mkdir -p $(BINDIR)
	install -m 755 bin/scalarisctl $(BINDIR)
	install -m 755 java-api/scalaris $(BINDIR)
