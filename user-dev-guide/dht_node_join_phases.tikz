\input{tikz_header}
% TODO: extend this picture and provide all paths between phases
\begin{tikzpicture}
 [rounded corners,
  pre/.style={<-,shorten <=1pt,>=stealth,semithick},
  post/.style={->,shorten >=1pt,>=stealth,semithick},
  timeout/.style={draw=black!50, dashed},
  phase/.style={rectangle,draw=black!50,top color=black!20,bottom color=white,very thick},
  bend angle=60]
 \node[phase] (phase1)                    {phase1};
 \node[phase] (phase2) [below=1.7 of phase1]  {phase2}
        edge [pre] node[auto, swap] {get\_known\_nodes()} (phase1);
 \node[phase] (phase2b) [below=1.7 of phase2] {phase2b}
        edge [pre] node[auto, swap, align=left]
         {
          get\_number\_of\_samples()\\
          \footnotesize{\textcolor{red}{passive load balancing,}}\\
          \footnotesize{\textcolor{red}{non-empty ContactNodes}}
         } (phase2);
 \node[phase] (phase3) [below=1.7 of phase2b] {phase3}
        edge [pre, bend left] node[auto, align=right]
         {
          lookup\_new\_ids2()\\
          ~\footnotesize{$\hookrightarrow$lookup\_new\_ids1()}\\
          ~~\scriptsize{$\hookrightarrow$lookup()}\\
          \footnotesize{\textcolor{red}{skip\_psv\_lb set,}}\\
          \footnotesize{\textcolor{red}{non-empty ContactNodes}}
         } (phase2)
        edge [pre] node[auto, swap, align=left]
         {
          lookup\_new\_ids2()\\
          ~\footnotesize{$\hookrightarrow$lookup\_new\_ids1()}\\
          ~~\scriptsize{$\hookrightarrow$lookup()}\\
         } (phase2b);
 \node[phase] (phase3b) [below=1.7 of phase3] {phase3b}
        edge [pre] node[auto, swap, align=left]
         {
          contact\_best\_candidate()\\
          \footnotesize{\textcolor{red}{Id != idholder.Id}}
         } (phase3);
 \node[phase] (phase4) [below=1.7 of phase3b] {phase4}
        edge [pre, bend left] node[auto, align=right]
         {
          contact\_best\_candidate()\\
          \footnotesize{$\rightarrow$ send\_join\_request()}\\
          \footnotesize{\textcolor{red}{Id == idholder.Id}}
         } (phase3)
        edge [pre] node[auto, swap] {send\_join\_request()} (phase3b); 
\end{tikzpicture}
\input{tikz_footer}
